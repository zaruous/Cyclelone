@startuml
autonumber
actor "Calling Service/Class" as Caller
participant "getInvLot Method" as Method
participant "Database" as DB

Caller -> Method: getInvLot(invLotId, sOper, sType, sReqNo)
activate Method

Method -> Method: invLotId 유효성 검사 (isEmpty)
alt invLotId 비어있음
    Method --> Caller: 빈 문자열 반환
    deactivate Method
end

Method -> Method: invLotId 형식 검사 (시작이 'P'이고 '|' 포함 여부)
alt invLotId가 'P|...' 형식임 (WMS 바코드)
    Method -> Method: invLotId를 '|' 기준으로 분리 (sLot 배열)
    alt 파싱 중 예외 발생
        Method -> Method: sLotId = "" 설정
        Method --> Caller: sLotId 반환
        deactivate Method
    end

    alt sType이 비어있음 (또는 null)
        Method -> DB: MInvLotSts 조회 (factoryCode, operCode, matCode, invLotCmf1, invLotCmf3 등)
        note right
            - invLotCmf4 (생산LOT) 조건: 자재코드('B' 또는 'C')
            - invLotCmf5 (유통기한) 조건: 자재코드('B')
            - invLotType = "RAW"
        end note
        DB --> Method: MInvLotSts 결과 반환
        alt MInvLotSts 조회됨
            Method -> Method: sLotId = invLotSts.getInvLotId()
        else MInvLotSts 조회 안 됨
            Method -> Method: sLotId = ""
        end
    else sType이 "RCV" (인수 목적)
        Method -> DB: CInvReqRcv 조회 (factoryCode, operCode, reqNo, matCode, pakingType, productDate 등)
        note right
            - productLotId (생산LOT) 조건: 자재코드('B' 또는 'C')
            - useDueDate (유통기한) 조건: 자재코드('B')
        end note
        DB --> Method: CInvReqRcv 결과 반환
        alt CInvReqRcv 조회됨
            Method -> Method: sLotId = invLotSts.getLotId()
        else CInvReqRcv 조회 안 됨
            Method -> Method: **새로운 LOT ID 조합 생성**
            note right
                - 'B' 코드: 자재코드-포장단위-제조일자-생산LOT-유통기한-창고코드
                - 'C' 코드: 자재코드-포장단위-제조일자-생산LOT-창고코드
                - 그 외: 자재코드-포장단위-제조일자-창고코드
            end note
            Method -> Method: sLotId = 조합된 문자열
        end
    end
else invLotId가 'P|...' 형식이 아님
    Method -> Method: sLotId = invLotId (입력값 그대로 사용)
end

Method --> Caller: sLotId 반환
deactivate Method
@enduml